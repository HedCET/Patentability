<dom-module id="inbox-view">

    <style>
    paper-fab {
        --paper-fab-background: var(--paper-red-500);
        --paper-fab-keyboard-focus-background: var(--paper-red-700);
    }
    
    paper-progress {
        --paper-progress-active-color: var(--paper-red-500);
        --paper-progress-secondary-color: var(--paper-red-100);
    }
    
    paper-toolbar {
        --paper-toolbar-background: var(--paper-blue-700);
        --paper-toolbar-color: white;
    }
    
    paper-toolbar paper-icon-button {
        margin: 0!important;
    }
    
    paper-toolbar paper-icon-button[icon="arrow-back"] {
        transform: translateX(-42px);
    }
    
    paper-toolbar.selection paper-icon-button[icon="arrow-back"] {
        transform: translateX(0);
    }
    
    paper-toolbar.selection .selection-hidden {
        display: none;
    }
    
    paper-toolbar.selection .selection-visible {
        padding: 8px;
        transform: rotateX(0);
        visibility: visible;
        width: 40px;
    }
    
    paper-toolbar .selection-visible {
        padding: 0;
        transform: rotateX(90deg);
        transition: transform 400ms ease-in-out;
        visibility: hidden;
        width: 0;
        will-change: transform;
    }
    
    paper-toolbar .title {
        padding: 0 12px;
    }
    
    .menu-b {
        bottom: 12px;
        position: fixed;
        right: 16px;
        transition: transform 0.2s ease-in-out;
        will-change: transform;
    }
    
    .menu-b.move-down {
        transform: translate3d(0, 80px, 0)!important;
    }
    </style>

    <template>
        <paper-scroll-header-panel class="fit">
            <paper-toolbar id="toolbar">
                <paper-icon-button class="selection-visible" icon="arrow-back" on-click="clear_patent_selected"></paper-icon-button>
                <paper-icon-button class="selection-hidden" icon="menu" on-click="menu_toggle" paper-drawer-toggle></paper-icon-button>

                <div class="title" id="toolbar-title">Patentability</div>

                <paper-icon-button class="selection-visible" icon="delete" on-click="remove_patent"></paper-icon-button>
                <paper-icon-button class="selection-visible" icon="social:share" on-click="share"></paper-icon-button>
                <paper-icon-button class="selection-hidden" icon="search" on-click="searchbar"></paper-icon-button>
            </paper-toolbar>

            <div class="blue-700" id="vis-patent-taxonomy" style="cursor: pointer; height: 256px"></div>

            <iron-selector activate-event="click" attr-for-selected="item" multi selectable="inbox-item" selected-attribute="selected" selected-values="{{patent_selected}}">
                <div class="blue-700 center-justified horizontal layout">
                    <div class="blue-500 center horizontal layout li">
                        <div class="cursor-d flex" style="font-size: 16px; line-height: 24px; padding: 16px;">[[item.keyword]] <span hidden="[[!item.cluster_keyword]]">/ <span>[[item.cluster_keyword]]</span></span>
                        </div>

                        <paper-icon-button icon="sort" on-click="sort"></paper-icon-button>
                        <paper-icon-button icon="close" onclick="document.querySelector('#remove-prompt').open();" style="margin-right: 8px;"></paper-icon-button>
                    </div>
                </div>

                <div class="center-justified horizontal layout">
                    <div class="li">
                        <paper-progress class="project-progress" data-id$="[[item._id]]" hidden style="width: 100%;"></paper-progress>
                    </div>
                </div>

                <template as="patent" is="dom-repeat" items="[[item.patent]]" sort="test">
                    <template if="[[is_object(patent)]]" is="dom-if">
                        <inbox-item item$="[[patent]]"></inbox-item>
                    </template>
                </template>
            </iron-selector>

            <div style="min-height: 80px;"></div>
        </paper-scroll-header-panel>

        <paper-fab class="menu-b" id="fab" icon="add" on-click="add_project"></paper-fab>

        <paper-dialog id="remove-prompt" style="width: 320px;" with-backdrop>
            <div style="font-size: 16px; line-height: 24px;">Are you sure to delete this project ?</div>

            <div class="buttons">
                <paper-button onclick="document.querySelector('#remove-prompt').close();">
                    <iron-icon icon="close"></iron-icon>
                    cancel
                </paper-button>
                <paper-button on-click="remove_ok">
                    <iron-icon icon="check"></iron-icon>
                    ok
                </paper-button>
            </div>
        </paper-dialog>
    </template>

    <script>
    Polymer({

        test: function(A, Z) {
            if (Object.prototype.toString.call(A) === "[object Object]" && Object.prototype.toString.call(Z) === "[object Object]") {
                console.log(A, Z);
            }
        },

        is: "inbox-view",

        is_object: function(item) {
            return (Object.prototype.toString.call(item) === "[object Object]" ? true : false);
        },

        menu_toggle: function() {
            document.querySelector("layout-inbox").menu_toggle();
        },

        observers: [
            "_item(item.patent.*)"
        ],

        _item: function(change) {
            console.log("change", change, "end");
        },

        properties: {
            item: {
                type: Object,
                value: function() {
                    return {};
                }
            },

            patent_selected: {
                type: Array,
                value: function() {
                    return [];
                }
            }
        },

        remove_ok: function(e) {
            if (Meteor.status().connected) {
                var _this = this;

                Meteor.call("remove_project", _this.item._id, function(error, response) {
                    if (error) {
                        document.querySelector("#polymer-toast").toast(error.reason);
                    } else {
                        document.querySelector("#polymer-toast").toast(response);

                        // home page
                    }
                });
            } else {
                document.querySelector("#polymer-toast").toast("server connection required");
            }

            this.$["remove-prompt"].close();
        },

        searchbar: function() {
            FlowRouter.setQueryParams({
                "route": "search"
            });
        },

        sort: function(e) {
            this.set("item.patent", _.sortBy(this.item.patent, "app_date"));

            document.querySelector("#polymer-toast").toast("sorted by app_date");
        },

        // subscribe_patent: function(project_id) {
        //     var _this = this,
        //         project = _project.findOne({
        //             _id: project_id
        //         });

        //     if (project) {
        //         var patent_id = _.map(project.patent, function(value) {
        //             return (_patent.findOne({
        //                 _id: value
        //             }) ? null : value);
        //         }).filter(Boolean);

        //         if (patent_id.length) {
        //             Meteor.subscribe("patent", patent_id, {
        //                 onReady: function() {
        //                     for (var A = 0; A < project.patent.length; A++) {
        //                         var item = _patent.findOne({
        //                             _id: project.patent[A]
        //                         });

        //                         project.patent[A] = (item ? item : {
        //                             _id: project.patent[A]
        //                         });

        //                         project.patent[A].project = {
        //                             _id: project._id
        //                         };
        //                     }

        //                     _this.item = project;

        //                     _this.vis_patent_taxonomy();
        //                 }
        //             });
        //         } else {
        //             for (var A = 0; A < project.patent.length; A++) {
        //                 var item = _patent.findOne({
        //                     _id: project.patent[A]
        //                 });

        //                 project.patent[A] = (item ? item : {
        //                     _id: project.patent[A]
        //                 });

        //                 project.patent[A].project = {
        //                     _id: project._id
        //                 };
        //             }

        //             _this.item = project;

        //             _this.vis_patent_taxonomy();
        //         }

        //         // observer
        //     }
        // },

        // subscribe_project: function(project_id) {
        //     var _this = this,
        //         project = _project.findOne({
        //             _id: project_id
        //         });

        //     if (project) {
        //         _this.subscribe_patent(project_id);
        //     } else {
        //         Meteor.subscribe("project", (project_id ? project_id : "#"), {
        //             onReady: function() {
        //                 _this.subscribe_patent(project_id);
        //             }
        //         });
        //     }

        //     // observer
        // },

        // vis_patent_taxonomy: function() {
        //     var edges = [],
        //         nodes = [],
        //         taxonomyA = {},
        //         taxonomyZ = {};

        //     this.item.patent.forEach(function(A) {
        //         if (_.has(A, "concept") && A.concept) {
        //             var B = A.concept.split(/;/).filter(Boolean);

        //             B.forEach(function(C) {
        //                 _key(taxonomyA, [C, A.p_no]);
        //             });
        //         }
        //     });

        //     Object.keys(taxonomyA).sort(function(keyA, keyZ) {
        //         return (_.size(taxonomyA[keyZ]) - _.size(taxonomyA[keyZ]));
        //     }).forEach(function(index) {
        //         if (_.size(taxonomyZ) < 10 && 1 < _.size(taxonomyA[index])) {
        //             taxonomyZ[index] = taxonomyA[index];
        //         }
        //     });

        //     _.each(taxonomyZ, function(valueA, keyA, list) {
        //         var idA = Random.id();

        //         nodes.push({
        //             color: {
        //                 background: "#2196F3",
        //                 border: "#FFFFFF",
        //                 highlight: {
        //                     background: "#64B5F6",
        //                     border: "#FFFFFF"
        //                 },
        //                 hover: {
        //                     background: "#64B5F6",
        //                     border: "#FFFFFF"
        //                 }
        //             },
        //             group: "taxonomy",
        //             id: idA,
        //             label: keyA,
        //             // size: _.size(valueA)
        //         });

        //         _.each(valueA, function(valueZ, keyZ, list) {
        //             var idZ = Random.id();

        //             nodes.push({
        //                 color: {
        //                     background: "#BBDEFB",
        //                     border: "#FFFFFF",
        //                     highlight: {
        //                         background: "#64B5F6",
        //                         border: "#FFFFFF"
        //                     },
        //                     hover: {
        //                         background: "#64B5F6",
        //                         border: "#FFFFFF"
        //                     }
        //                 },
        //                 group: "patent",
        //                 id: idZ,
        //                 label: keyZ,
        //                 // size: valueZ
        //             });

        //             edges.push({
        //                 from: idZ,
        //                 to: idA
        //             })
        //         });
        //     });

        //     network = new vis.Network(document.querySelector("#vis-patent-taxonomy"), {
        //         nodes: new vis.DataSet(nodes),
        //         edges: new vis.DataSet(edges)
        //     }, {
        //         edges: {
        //             shadow: true,
        //             width: 2
        //         },
        //         groups: {
        //             patent: {
        //                 shape: "diamond"
        //             },
        //             taxonomy: {
        //                 shape: "dot"
        //             }
        //         },
        //         interaction: {
        //             hover: true
        //         },
        //         nodes: {
        //             borderWidth: 2,
        //             font: {
        //                 color: "#FFFFFF",
        //                 size: 16
        //             },
        //             shadow: true
        //         }
        //     });

        //     network.once("afterDrawing", function(ctx) {
        //         network.moveTo({
        //             scale: .5
        //         });
        //     });
        // }

    });
    </script>

</dom-module>
