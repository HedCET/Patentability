<dom-module id="search-bar">

    <style>
    :host {
        display: none;
    }
    
    :host([active]) {
        display: block;
    }
    
    paper-toolbar {
        --paper-toolbar-background: white;
        --paper-toolbar-color: black;
    }
    
    paper-progress {
        --paper-progress-active-color: #009688;
    }
    
    input {
        background: transparent;
        border: none;
        font-size: 18px;
        padding: 0 8px;
    }
    </style>

    <template>
        <paper-header-panel class="fit" style="background: rgba(238, 238, 238, 0.75); z-index: 1;">
            <paper-toolbar>
                <paper-icon-button icon="arrow-back" on-tap="toggle"></paper-icon-button>
                <input class="flex" id="input" on-keyup="doSearch" placeholder="patentability search">
                <paper-icon-button icon="filter-list" on-tap="filter"></paper-icon-button>
            </paper-toolbar>
            <div class="center-justified horizontal layout">
                <div class="li">
                    <div class="bordered cursor-d etc" id="title" style="padding: 16px;">empty</div>
                    <div style="padding: 0 8px;">
                        <paper-progress hidden id="progress" indeterminate style="width: 100%;"></paper-progress>
                    </div>
                    <iron-selector on-iron-activate="onSelect">
                        <template is="dom-repeat" items="[[list]]">
                            <paper-icon-item class="bg-white bordered cursor-p hover relative" data-keyword$="[[item.keyword]]">
                                <div item-icon>
                                    <selectable-icon icon_class$="[[icon_class(item.keyword)]]" icon_text$="[[icon_text(item.keyword)]]"></selectable-icon>
                                </div>
                                <paper-item-body two-line>
                                    <div class="lowercase">[[item.keyword]]</div>
                                    <div secondary>patent count - <span>[[item.count]]</span></div>
                                </paper-item-body>
                                <paper-ripple></paper-ripple>
                            </paper-icon-item>
                        </template>
                    </iron-selector>
                    <div style="min-height: 80px;"></div>
                </div>
            </div>
        </paper-header-panel>
    </template>

    <script>
    Polymer({

        doSearch: function() {
            var q = this.$.input.value.replace(/[^0-9a-zA-Z]/g, " ").replace(/\s+/g, " ").trim();

            if (q.length) {
                this.$.progress.hidden = false;
                this.$.title.textContent = "searching ..";

                this.debounce("search", function() {
                    var _this = this;

                    Meteor.call("cluster", q, function(error, response) {
                        _this.list = [];

                        _this.$.progress.hidden = true;
                        _this.$.title.textContent = "empty";

                        if (error) {
                            document.querySelector("layout-inbox").toast(error.reason);
                        } else {
                            if (JSON.parse(response) instanceof Array) {
                                _this.list = JSON.parse(response);

                                if (_this.list.length) {
                                    _this.$.title.textContent = _this.list.length + " patent category exists";
                                }
                            }
                        }
                    });
                }, 2000);
            } else {
                this.$.progress.hidden = true;
                this.$.title.textContent = "empty";
            }
        },

        filter: function() {
            document.querySelector("layout-inbox").toast("searchFilterNotFound");
        },

        onSelect: function(e, d) {
            this.async(function() {
                var q = d.item.dataset.keyword.replace(/[^0-9a-zA-Z]/g, " ").replace(/\s+/g, " ").trim();

                if (q.length) {
                    var _this = this;

                    Meteor.call("insert_keyword", q, function(error, response) {
                        _this.toggle();

                        if (error) {
                            document.querySelector("layout-inbox").toast(error.reason);
                        } else {
                            document.querySelector("layout-inbox").store(response);
                            document.querySelector("layout-inbox").toast("1 concept stored");
                        }
                    });
                } else {
                    document.querySelector("layout-inbox").toast("blank concept");
                }
            }, 200);
        },

        icon_class: function(text) {
            return polymer_color(text);
        },

        icon_text: function(text) {
            var A = text.charAt(0);

            if (isNaN(parseInt(A))) {
                return A;
            } else {
                return "#";
            }
        },

        is: "search-bar",

        properties: {
            active: {
                notify: true,
                reflectToAttribute: true,
                type: Boolean,
                value: false
            },
            list: {
                type: Array,
                value: function() {
                    return [];
                }
            }
        },

        toggle: function() {
            this.active = !this.active;

            if (this.active) {
                this.async(function() {
                    this.$.input.focus();
                }, 400);
            }
        }

    });
    </script>

</dom-module>
