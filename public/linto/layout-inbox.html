<dom-module id="layout-inbox">

    <style>
    paper-drawer-panel /deep/ #drawer,
    paper-drawer-panel /deep/ #main #scrim {
        z-index: 1;
    }
    
    paper-fab {
        --paper-fab-background: var(--paper-red-500);
        --paper-fab-keyboard-focus-background: var(--paper-red-700);
    }
    
    paper-toolbar {
        --paper-toolbar-background: #009688;
        --paper-toolbar-color: white;
    }
    
    paper-toolbar paper-icon-button {
        margin: 0!important;
    }
    
    paper-toolbar paper-icon-button[icon="arrow-back"] {
        transform: translateX(-42px);
    }
    
    paper-toolbar.selection paper-icon-button[icon="arrow-back"] {
        transform: translateX(0);
    }
    
    paper-toolbar.selection .selection-hidden {
        display: none;
    }
    
    paper-toolbar.selection .selection-visible {
        padding: 8px;
        transform: rotateX(0);
        visibility: visible;
        width: auto;
    }
    
    paper-toolbar .selection-visible {
        padding: 0;
        transform: rotateX(90deg);
        transition: transform 400ms ease-in-out;
        visibility: hidden;
        width: 0;
        will-change: transform;
    }
    
    paper-toolbar .title {
        padding: 0 12px;
    }
    
    .menu-li {
        border-bottom: 2px solid #EEE;
        border-top: 2px solid #EEE;
    }
    
    .menu-b {
        bottom: 12px;
        position: fixed;
        right: 16px;
        -webkit-transition: -webkit-transform 0.2s ease-in-out;
        transition: transform 0.2s ease-in-out;
        will-change: transform;
    }
    
    .menu-b.move-down {
        transform: translate3d(0, 80px, 0)!important;
    }
    </style>

    <template>
        <iron-localstorage name="patentability" on-iron-localstorage-load-empty="initialize" value="{{list}}"></iron-localstorage>

        <paper-drawer-panel id="paper_drawer_panel">
            <paper-header-panel drawer>
                <iron-selector>
                    <paper-icon-item class="cursor-p hover menu-li relative">
                        <div item-icon>
                            <selectable-icon icon_img_src="/img/github.png"></selectable-icon>
                        </div>

                        <paper-item-body two-line style="margin-right: 0; min-height: 0; padding: 14px 0;">
                            <div>open source</div>
                            <div secondary>build break develop</div>
                        </paper-item-body>

                        <!-- <paper-ripple></paper-ripple> -->
                    </paper-icon-item>

                    <template is="dom-repeat" items="[[list]]">
                        <template if="[[lessThan(item.patent.length, 100)]]" is="dom-if">
                            <paper-icon-item class="cursor-p hover menu-li relative" data-id$="[[item._id]]">
                                <div item-icon>
                                    <selectable-icon icon_class$="[[icon_class(item.keyword)]]" icon_text$="[[icon_count(item.patent.length)]]"></selectable-icon>
                                </div>

                                <paper-item-body two-line style="margin-right: 0; min-height: 0; padding: 14px 0;">
                                    <div class="lowercase">
                                        <span hidden$="[[!item.cluster_keyword]]">[[item.cluster_keyword]]</span>
                                        <span hidden$="[[item.cluster_keyword]]">[[item.keyword]]</span>
                                    </div>

                                    <div secondary>
                                        <span hidden$="[[!item.cluster_keyword]]">topic - <span class="lowercase">[[item.keyword]]</span></span>
                                        <span hidden$="[[item.cluster_keyword]]">concept</span>
                                    </div>
                                </paper-item-body>

                                <!-- <paper-ripple></paper-ripple> -->
                            </paper-icon-item>
                        </template>
                    </template>
                </iron-selector>
            </paper-header-panel>

            <paper-header-panel main>
                <paper-toolbar id="toolBar">
                    <paper-icon-button class="selection-visible" icon="arrow-back" on-tap="clear_list_selection"></paper-icon-button>
                    <paper-icon-button class="selection-hidden" icon="menu" on-tap="menuToggle"></paper-icon-button>

                    <div class="title" id="toolBarTitle"></div>

                    <paper-icon-button class="selection-visible" icon="delete" on-tap="remove_patent"></paper-icon-button>
                    <paper-icon-button class="selection-visible" icon="social:share"></paper-icon-button>
                    <paper-icon-button class="selection-visible" icon="more-vert"></paper-icon-button>
                    <paper-icon-button class="selection-hidden" icon="search" on-tap="search"></paper-icon-button>
                </paper-toolbar>

                <neon-animated-pages class="fit" selected="[[page_index]]">
                    <neon-animatable class="center-center layout vertical">
                        <div>empty</div>
                    </neon-animatable>

                    <neon-animatable class="layout vertical">
                        <div class="center-justified horizontal layout">
                            <div class="li">
                                <iron-selector attr-for-selected="item" multi selectable="inbox-item" selected-attribute="selected" selected-values="{{list_selected}}">
                                    <template as="row" is="dom-repeat" items="[[list]]">
                                        <div class="bordered center horizontal justified layout">
                                            <div class="cursor-d etc lowercase" style="padding: 16px;">
                                                <span hidden$="[[!row.cluster_keyword]]">[[row.cluster_keyword]]</span>
                                                <span hidden$="[[row.cluster_keyword]]">[[row.keyword]]</span>
                                            </div>

                                            <paper-icon-button icon="close" id$="[[row._id]]" on-tap="removeIcon"></paper-icon-row>
                                        </div>

                                        <div style="padding: 0 8px;">
                                            <paper-progress hidden$="[[boolean(row.patent.length)]]" indeterminate style="width: 100%;"></paper-progress>
                                        </div>

                                        <template as="patent" is="dom-repeat" items="[[row.patent]]">
                                            <template if="[[!patent.hidden]]" is="dom-if">
                                                <inbox-item item="[[patent]]"></inbox-item>
                                            </template>
                                        </template>
                                    </template>
                                </iron-selector>

                                <div style="min-height: 80px;"></div>
                            </div>
                        </div>
                    </neon-animatable>
                </neon-animated-pages>
            </paper-header-panel>
        </paper-drawer-panel>

        <paper-fab class="menu-b" id="fab" icon="add" on-tap="addFab"></paper-fab>

        <paper-dialog id="add" style="width: 320px;">
            <div>Add your concept in single line, Our semantic search will check patentability</div>

            <paper-input id="keyword" label="add concept"></paper-input>

            <div class="buttons">
                <paper-button dialog-dismiss>
                    <iron-icon icon="close"></iron-icon>
                    cancel
                </paper-button>
                <paper-button dialog-confirm on-tap="addButton">
                    <iron-icon icon="check"></iron-icon>
                    ok
                </paper-button>
            </div>
        </paper-dialog>

        <paper-dialog data-queue="12345" id="remove" style="width: 320px;">
            <div>Are you sure to delete this item ?</div>

            <div class="buttons">
                <paper-button dialog-dismiss>
                    <iron-icon icon="close"></iron-icon>
                    cancel
                </paper-button>
                <paper-button dialog-confirm on-tap="removeButton">
                    <iron-icon icon="check"></iron-icon>
                    ok
                </paper-button>
            </div>
        </paper-dialog>

        <search-bar id="searchBar"></search-bar>

        <paper-toast class="cursor-d horizontal justified layout" duration="4000" id="layout_inbox_toast" on-transitionend="layout_inbox_toast" style="font-size: 14px; margin-right: 12px; padding: 16px; z-index: 1000;" text="">
            <div class="cursor-p self-start" hidden$="[[!boolean(undo.length)]]" on-tap="undo_patent" style="color: #FFEB3B; margin-left: 8px;">UNDO</div>
        </paper-toast>
    </template>

    <script>
    Polymer({

        addButton: function() {
            var keyword = this.$.keyword.value.trim();

            if (keyword.length) {
                this.$.keyword.value = "";

                var _this = this;

                Meteor.call("insert_seed", {
                    keyword: keyword
                }, function(error, response) {
                    if (error) {
                        _this.toast(error.reason);
                    } else {
                        _this.bind(response);
                    }
                });
            } else {
                this.toast("empty concept");
            }
        },

        addFab: function() {
            this.$.add.open();
        },

        boolean: function(boolean) {
            return (boolean ? true : false);
        },

        clear_list_selection: function() {
            this.list_selected = [];
        },

        bind: function(item, removed) {
            var index = -1;

            var exists = _.find(this.list, function(A) {
                index++;

                return (item._id == A._id);
            });

            if (exists) {
                if (removed) {
                    this.splice("list", index, 1);
                    this.toast("1 concept removed");
                } else {
                    this.set("list." + index, item);
                    this.toast("1 concept changed");
                }
            } else {
                this.push("list", item);
                this.toast("1 concept added");

                Meteor.subscribe("patentability", _.map(this.list, function(A) {
                    return A._id;
                }));
            }
        },

        icon_class: function(text) {
            return polymer_color(text);
        },

        icon_count: function(count) {
            return (1 < count ? count : "#");
        },

        initialize: function() {
            this.set("list", []);
        },

        is: "layout-inbox",

        layout_inbox_toast: function(e) {
            if (this.$.layout_inbox_toast.visible) {
                this.$.fab.translate3d(0, "-" + ($("#layout_inbox_toast #label").height() + 46) + "px", 0);
            } else {
                this.$.fab.translate3d(0, 0, 0);

                if (this.undo.length) {
                    this.set("undo", []);
                }
            }
        },

        lessThan: function(A, B) {
            return A < B;
        },

        menuToggle: function() {
            if (this.$.paper_drawer_panel.narrow && $(this.$.paper_drawer_panel).width() <= parseInt(this.$.paper_drawer_panel.responsiveWidth)) {
                this.$.paper_drawer_panel.togglePanel();
            } else {
                this.$.paper_drawer_panel.forceNarrow = !this.$.paper_drawer_panel.forceNarrow;
            }
        },

        observers: [
            "_listChanged(list.splices)",
            "_listSelectedChanged(list_selected.splices)"
        ],

        properties: {
            list: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            list_selected: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            page_index: {
                type: Number,
                value: 1
            },
            undo: {
                type: Array,
                value: function() {
                    return [];
                }
            }
        },

        remove_patent: function() {
            this.undo = _.map(this.list_selected, function(A) {
                return A._id;
            });

            for (var A = 0; A < this.list.length; A++) {
                for (var Z = 0; Z < this.list[A].patent.length; Z++) {
                    if (-1 < this.undo.indexOf(this.list[A].patent[Z]._id)) {
                        this.set("list." + A + ".patent." + Z + ".hidden", true);
                    }
                }
            }

            this.toast(this.undo.length + " patent removed");
        },

        removeIcon: function(e) {
            this.$.remove.dataset.queue = Polymer.dom(e).localTarget.id;
            this.$.remove.open();
        },

        removeButton: function() {
            var id = this.$.remove.dataset.queue,
                index = -1;

            var exists = _.find(this.list, function(A) {
                index++;

                return (id == A._id);
            });

            if (exists) {
                this.splice("list", index, 1);
                this.toast("1 concept removed");
            }
        },

        search: function() {
            this.$.searchBar.toggle();
        },

        toast: function(text) {
            this.$.layout_inbox_toast.hide();

            this.async(function() {
                this.$.layout_inbox_toast.text = text;
                this.$.layout_inbox_toast.show();
            }, 400);
        },

        undo_patent: function() {
            for (var A = 0; A < this.list.length; A++) {
                for (var Z = 0; Z < this.list[A].patent.length; Z++) {
                    if (-1 < this.undo.indexOf(this.list[A].patent[Z]._id)) {
                        this.set("list." + A + ".patent." + Z + ".hidden", false);
                    }
                }
            }
        },

        _listChanged: function(change) {
            this.page_index = (this.list.length ? 1 : 0);
        },

        _listSelectedChanged: function(change) {
            this.$.toolBarTitle.textContent = (this.list_selected.length ? this.list_selected.length : "patentability store");

            this.$.toolBar.toggleClass("grey-500", this.list_selected.length);
            this.$.toolBar.toggleClass("selection", this.list_selected.length);

            this.$.fab.toggleClass("move-down", this.list_selected.length);
        }

    });
    </script>

</dom-module>
